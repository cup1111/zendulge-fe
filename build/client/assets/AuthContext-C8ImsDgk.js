import{a as c,R as k,p as w}from"./chunk-NISHYRIK-qw7nT2B7.js";import{a as x}from"./index-ngrFHoWO.js";const S={BASE_URL:"https://zendulge-be-production.up.railway.app",API_PREFIX:"/api/v1",get FULL_URL(){return`${this.BASE_URL}${this.API_PREFIX}`},endpoints:{auth:{login:"/login",logout:"/logout",refresh:"/refresh-token",profile:"/me"},company:{operateSites:e=>`/company/${e}/operate-sites`,users:e=>`/company/${e}/users`,user:(e,t)=>`/company/${e}/users/${t}`,userRole:(e,t)=>`/company/${e}/users/${t}/role`,roles:e=>`/company/${e}/roles`}}},L=()=>localStorage.getItem("accessToken")??localStorage.getItem("token"),y=x.create({baseURL:S.FULL_URL,timeout:3e4,headers:{"Content-Type":"application/json"}});y.interceptors.request.use(e=>{const t=L();return t&&(e.headers.Authorization=`Bearer ${t}`),e},e=>Promise.reject(e));y.interceptors.response.use(e=>e,e=>(e.response?.status===401?console.warn("Authentication failed - token may be expired"):e.response?.status===403?console.warn("Access forbidden - insufficient permissions"):e.response?.status>=500&&console.error("Server error occurred"),Promise.reject(e)));const C=c.createContext(void 0);function h(e){try{const i=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),u=decodeURIComponent(atob(i).split("").map(p=>`%${`00${p.charCodeAt(0).toString(16)}`.slice(-2)}`).join("")),o=JSON.parse(u);return{id:o.id,email:o.email,firstName:o.firstName,lastName:o.lastName,userName:o.userName,avatarIcon:o.avatarIcon,role:o.role,companies:o.companies||[]}}catch(t){return console.error("Error decoding JWT:",t),null}}const U=({children:e})=>{const[t,i]=c.useState(null),[u,o]=c.useState(null),[p,f]=c.useState(!0),m=()=>{i(null),o(null),localStorage.removeItem("user"),localStorage.removeItem("currentCompany"),localStorage.removeItem("accessToken"),localStorage.removeItem("token")},I=c.useCallback(async(l,a)=>{try{const r=await y.post(S.endpoints.auth.login,{email:l,password:a}),{data:d}=r,{accessToken:g}=d.data;localStorage.setItem("accessToken",g);const n=h(g);if(!n)throw new Error("Invalid token received");if(i(n),n.companies&&n.companies.length>0){const s=n.companies[0];o(s),localStorage.setItem("currentCompany",JSON.stringify(s))}}catch(r){throw console.error("Login error:",r),r}},[]),A=l=>{o(l),localStorage.setItem("currentCompany",JSON.stringify(l))};c.useEffect(()=>{(async()=>{try{f(!0);const a=localStorage.getItem("accessToken")??localStorage.getItem("token");if(!a){f(!1);return}const r=h(a);if(!r){m(),window.location.href="/";return}const d=JSON.parse(atob(a.split(".")[1])),g=Date.now()/1e3;if(d.exp&&d.exp<g){m(),window.location.href="/";return}i(r);const n=localStorage.getItem("currentCompany");if(n)try{const s=JSON.parse(n);o(s)}catch(s){console.error("Error parsing saved company:",s)}else if(r.companies&&r.companies.length>0){const s=r.companies[0];o(s),localStorage.setItem("currentCompany",JSON.stringify(s))}}catch(a){console.error("Error initializing auth:",a),m()}finally{f(!1)}})()},[]);const v=k.useMemo(()=>({user:t,currentCompany:u,companies:t?.companies??[],isAuthenticated:!!t,isLoading:p,login:I,setCurrentCompany:A,logout:m}),[t,u,p]);return w.jsx(C.Provider,{value:v,children:e})};function $(){const e=c.useContext(C);return e===void 0?(console.warn("useAuth called outside AuthProvider, using defaults"),{user:null,currentCompany:null,companies:[],isAuthenticated:!1,isLoading:!1,login:async()=>{},setCurrentCompany:()=>{},logout:()=>{}}):e}export{U as A,S as a,$ as u,y as z};
